# Yelp Workflow Cheatsheet

This app ingests Yelp places into Supabase and stores photo URLs (not the images themselves) for display. Use these scripts to add specific spots, enforce halal status, and pull photos.

Prereqs
- Node 18+
- Env vars (private): `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `YELP_API_KEY`

Files
- `data/yelp_halal.json` – main dataset (autogenerated by fetch or appended via add-manual script)
- `scripts/manual_yelp_ids.txt` – convenience list of Yelp ids/URLs to force‑include
- `scripts/yelp_ingest.js` – upserts places into Supabase
- `scripts/yelp_hydrate_alcohol.js` – fetches Yelp details to set `serves_alcohol` for existing Yelp places
- `scripts/yelp_photos_ingest.js` – imports Yelp photo URLs into `place_photo`
- `scripts/yelp_add_manual_id.js` – append one Yelp business to `data/yelp_halal.json`
- `scripts/yelp_halal_fetch.js` – fetches halal places across bbox tiles (can also accept `--idsFile`)

Mark certain brands as fully halal
- `scripts/yelp_ingest.js` contains `forcedFullyHalalPrefixes`. I added `kebabish` and `kebabishq` so KebabishQ is tagged `only` automatically.

Add KebabishQ (NYC) and import photos
1) Append to dataset (one‑off):
   - `cd HalalFood`
   - `YELP_API_KEY=... node scripts/yelp_add_manual_id.js https://www.yelp.com/biz/kebabishq-new-york data/yelp_halal.json`

   Alternative (batch via file):
   - `YELP_API_KEY=... node scripts/yelp_halal_fetch.js --bboxFile=overpass-bboxes.txt --idsFile=scripts/manual_yelp_ids.txt --outDir=data`

2) Upsert place into Supabase:
   - `node scripts/yelp_ingest.js --file=data/yelp_halal.json --supabaseUrl=$SUPABASE_URL --serviceKey=$SUPABASE_SERVICE_ROLE_KEY --batchSize=300`

3) Import Yelp photos for KebabishQ and Sma.sha:
   - `YELP_API_KEY=... node scripts/yelp_photos_ingest.js --supabaseUrl=$SUPABASE_URL --serviceKey=$SUPABASE_SERVICE_ROLE_KEY --id=kebabishq-new-york --maxPhotos=24 --delayMs=200`
   - `YELP_API_KEY=... node scripts/yelp_photos_ingest.js --supabaseUrl=$SUPABASE_URL --serviceKey=$SUPABASE_SERVICE_ROLE_KEY --id=sma-sha-long-island-city-2 --maxPhotos=24 --delayMs=200`

Add to New Spots section
- After upsert, get the new place id:
  - `curl "$SUPABASE_URL/rest/v1/place?select=id,name,external_id&source=eq.yelp&external_id=eq.yelp:kebabishq-new-york" -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY"`
- Then add a `NewSpotConfig` in `ContentView.swift` with that UUID and a good hero image URL (Yelp `o.jpg` size works well).

Notes
- Photos are stored as remote URLs with attribution (`place_photo.src='yelp'`). We do not download/host images.
- `forcedFullyHalalPrefixes` sets halal_status = `only` for matching names; adjust if needed.
- If an entry already exists, `yelp_ingest.js` uses on_conflict merge.
- `yelp_hydrate_alcohol.js` uses one Yelp API call per place; start with a small `--limit` to avoid rate limits.

Add MOTW Coffee (Hicksville) and import photos
1) Append to dataset (one‑off):
   - `cd HalalFood`
   - `YELP_API_KEY=… node scripts/yelp_add_manual_id.js https://www.yelp.com/biz/motw-coffee-hicksville data/yelp_halal.json`

   Alternative (from the prefilled list):
   - Ensure `scripts/manual_yelp_ids.txt` contains the URL
   - `YELP_API_KEY=… node scripts/yelp_halal_fetch.js --bboxFile=overpass-bboxes.txt --idsFile=scripts/manual_yelp_ids.txt --outDir=data`

2) Upsert place into Supabase:
   - `node scripts/yelp_ingest.js --file=data/yelp_halal.json --supabaseUrl=$SUPABASE_URL --serviceKey=$SUPABASE_SERVICE_ROLE_KEY --batchSize=300`

3) Import Yelp photos for MOTW Coffee:
   - `YELP_API_KEY=… node scripts/yelp_photos_ingest.js --supabaseUrl=$SUPABASE_URL --serviceKey=$SUPABASE_SERVICE_ROLE_KEY --id=motw-coffee-hicksville --maxPhotos=24 --delayMs=200`

4) Fetch the new place UUID:
   - `curl "$SUPABASE_URL/rest/v1/place?select=id,name,external_id,display_location&source=eq.yelp&external_id=eq.yelp:motw-coffee-hicksville" -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" | jq` 

5) Add to New Spots in `ContentView.swift`:
   Paste a new `NewSpotConfig` into the `newSpotConfigs` array, replacing placeholders with the UUID from step 4 and a good Yelp hero photo URL (from step 3).

   Example snippet (Fully halal; opening Nov 1):
   ```swift
   NewSpotConfig(
       placeID: UUID(uuidString: "<PASTE_UUID>")!,
       imageURL: URL(string: "<HERO_IMAGE_URL>")!, // e.g. a yelpcdn.com/o.jpg photo
       photoDescription: "MOTW Coffee signature latte",
       displayLocation: "Hicksville, Long Island",
       cuisine: "Coffee",
       halalStatusOverride: .only,
       openedOn: ("NOV", "01"),
       spotlightSummary: nil,
       spotlightDetails: "Fully halal"
   )
   ```

Env quick refs
- `SUPABASE_URL`: `https://<project>.supabase.co` (e.g., `https://qecnntkyxbcwtwyzlqku.supabase.co`)
- `SUPABASE_SERVICE_ROLE_KEY`: service role secret for the project
- `YELP_API_KEY`: Yelp Fusion API key
